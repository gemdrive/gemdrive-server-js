<!doctype html>
<html>
  <head>
  </head>

  <body>
    <script>

      const LoginView = (rootUrl) => {
        const dom = document.createElement('div');
        dom.classList.add('remfs-delver__login');
      
        render();
      
        function render() {
      
          removeAllChildren(dom);
      
          const headerEl = document.createElement('h1');
          headerEl.innerText = "Login";
          dom.appendChild(headerEl);
      
          const emailLabelEl = document.createElement('div');
          emailLabelEl.innerText = "Email:";
          dom.appendChild(emailLabelEl);
      
          const emailEl = document.createElement('input');
          emailEl.type = 'email';
          dom.appendChild(emailEl);
      
          const submitEl = document.createElement('button');
          submitEl.innerText = 'Submit';
          submitEl.addEventListener('click', (e) => {
      
            dom.innerHTML = '<h1>Check your email to confirm login</h1>';
      
            fetch(rootUrl + '?pauth-method=dummy', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                jsonrpc: '2.0',
                method: 'authorize',
                params: {
                  email: emailEl.value,
                  perms: {
                    "/": {
                      own: true,
                    },
                  },
                }
              }),
            })
            .then(response => {
              console.log(response);
              if (response.status !== 200) {
                throw new Error("Authorization failed");
              }
      
              return response.text();
            })
            .then(token => {
              dom.dispatchEvent(new CustomEvent('authorized', {
                bubbles: true,
                detail: {
                  token,
                },
              }));
            })
            .catch(e => {
              console.error(e);
              alert("Login failed. Please try again");
              render();
            });
          });
          dom.appendChild(submitEl);
        }
      
        return dom;
      };
      
      function removeAllChildren(el) {
        while (el.firstChild) {
          el.removeChild(el.firstChild);
        }
      }
      
      const loginView = LoginView('');
      loginView.addEventListener('authorized', () => {
        location.reload();
      });
      
      document.body.appendChild(loginView);

    </script>
  </body>
</html>
